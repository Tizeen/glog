<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Problems on Glog</title>
    <link>http://localhost:1313/tags/problems/</link>
    <description>Recent content in Problems on Glog</description>
    <generator>Hugo</generator>
    <language>zh-cn</language>
    <lastBuildDate>Wed, 25 Dec 2024 09:05:37 +0000</lastBuildDate>
    <atom:link href="http://localhost:1313/tags/problems/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>大小问题记录</title>
      <link>http://localhost:1313/2024/12/25/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95/</link>
      <pubDate>Wed, 25 Dec 2024 09:05:37 +0000</pubDate>
      <guid>http://localhost:1313/2024/12/25/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95/</guid>
      <description>&lt;p&gt;记录遇到的相关问题。&lt;/p&gt;&#xA;&lt;h2 class=&#34;wp-block-heading&#34; id=&#34;阿里云slb-5xx和4xx波动&#34;&gt;阿里云slb 5xx和4xx波动&lt;/h2&gt;&#xA;&lt;p&gt;现象：&lt;/p&gt;&#xA;&lt;ol class=&#34;wp-block-list&#34;&gt;&#xA;  &lt;li&gt;&#xA;    告警平台发生 slb 5xx 和 4xx 波动告警&#xA;  &lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;排查过程：&lt;/p&gt;&#xA;&lt;ol class=&#34;wp-block-list&#34;&gt;&#xA;  &lt;li&gt;&#xA;    通过 slb 日志过滤，5xx 中主要是 502 占比很高，4xx 中主要是 499 的占比很高，只有一个域名出现此状况&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    通过 502 状态码初步判断是后端服务不可用，然后客户端在不断重试，导致 499 状态码的请求增多&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    根据域名和 slb 的监听定位后端服务，检查最底层后端服务，发现 nginx error log 中提示 upstream 无法连接&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    upstream 的后端是 php 的服务，查看运行状态正常，服务没有挂掉&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    判断是服务处理不过来，可能是配置的线程数可能太少，影响了服务的处理能力&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    检查配置文件，发现 pm.max_children 配置仅有 5&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    提升 pm.max_children 值到 10 倍到 50，重启 php-fpm&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    观察 nginx error log，发现错误已恢复&#xA;  &lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;后续：&lt;/p&gt;&#xA;&lt;ol class=&#34;wp-block-list&#34;&gt;&#xA;  &lt;li&gt;&#xA;    仅配置 pm.max_children 并不是一个合理的做法，同时还需要调整 pm.start_servers, pm.min_spare_servers, pm.max_spare_server&lt;br /&gt;pm.start_servers(初始进程值) 一般是 max_children 值的 20%&lt;br /&gt;pm.min_spare_servers(至少保持空闲的进程值) 一般是 pm.start_servers 的 50%&lt;br /&gt;pm.max_spare_servers(最大保持空闲值) 一般是 pm.start_servers 的 2 倍&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    需要注意的是，pm.max_children 需要根据服务器的资源情况来决定&#xA;  &lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;总结：&lt;/p&gt;</description>
    </item>
    <item>
      <title>CDN资源被盗刷记录</title>
      <link>http://localhost:1313/2024/08/20/cdn%E8%B5%84%E6%BA%90%E8%A2%AB%E7%9B%97%E5%88%B7%E8%AE%B0%E5%BD%95/</link>
      <pubDate>Tue, 20 Aug 2024 02:17:45 +0000</pubDate>
      <guid>http://localhost:1313/2024/08/20/cdn%E8%B5%84%E6%BA%90%E8%A2%AB%E7%9B%97%E5%88%B7%E8%AE%B0%E5%BD%95/</guid>
      <description>&lt;h2 class=&#34;wp-block-heading&#34; id=&#34;问题&#34;&gt;问题&lt;/h2&gt;&#xA;&lt;ol class=&#34;wp-block-list&#34;&gt;&#xA;  &lt;li&gt;&#xA;    带宽使用从平时的 2Gbps 提升到了 20Gbps&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    每日的 CDN 费用从 2000 上涨到了 20000&#xA;  &lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;h2 class=&#34;wp-block-heading&#34; id=&#34;处理&#34;&gt;处理&lt;/h2&gt;&#xA;&lt;ol class=&#34;wp-block-list&#34;&gt;&#xA;  &lt;li&gt;&#xA;    通过监控发现，现状已经持续了 5 天左右&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    查看运营报表（阿里云自带），发现有几个特定的 IP 一直在访问一个 APK 资源，并且过去 7 天下载了 1.4PB 的流量&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    在 CDN 控制台中封禁这些 IP，带宽使用下降&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    发现攻击者切换 IP ，继续访问这个 APK 资源，带宽使用上涨&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    配置此资源下载限速，一开始配置的 20MB，发现仅对单次连接生效，效果不佳，降低到最低限速 100Kb，带宽使用下降&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    攻击者还是在切换 IP 持续访问&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    确定资源是 2020 年的资源，目前已不在使用&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    从源站中重命名资源，刷新 CDN 缓存，从而清除 CDN 中的缓存&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    此时再访问资源 404，带宽使用恢复&#xA;  &lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;h2 class=&#34;wp-block-heading&#34; id=&#34;思考&#34;&gt;思考&lt;/h2&gt;&#xA;&lt;p&gt;存在的问题：&lt;/p&gt;&#xA;&lt;ol class=&#34;wp-block-list&#34;&gt;&#xA;  &lt;li&gt;&#xA;    没有及时发现流量被盗刷&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    没有限速机制&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    历史资源没有生命周期管理机制，一直存在&#xA;  &lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;如果攻击者更换了新的 IP 和资源，我们应该怎么办？&lt;/p&gt;&#xA;&lt;ol class=&#34;wp-block-list&#34;&gt;&#xA;  &lt;li&gt;&#xA;    需要考虑使用其他的特征来进行封禁，例如 User-Agent、Referer 等内容&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    考虑接入 WAF ，利用 WAF 来封禁&#xA;  &lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;&lt;strong&gt;应该如何防止此类事件？&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ol class=&#34;wp-block-list&#34;&gt;&#xA;  &lt;li&gt;&#xA;    添加监控。对于按使用量计算的指标，可以添加对应的上限监控。例如：带宽、流量、费用&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    配置下载限速&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    建立资源的生命周期机制。没有资源的下线机制，冗余资源会越来越多&#xA;  &lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;h2 class=&#34;wp-block-heading&#34; id=&#34;为什么被刷&#34;&gt;为什么被刷&lt;/h2&gt;&#xA;&lt;p&gt;网络上看到的解释，对比当时的场景十分符合，针对一个 url 不停的下载，去平衡 pcdn 的下载流量，避免家庭带宽上传过多被运营商封禁。&lt;figure class=&#34;wp-block-image size-large&#34;&gt;&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
